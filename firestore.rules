rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Sprawdzenie czy użytkownik jest zalogowany
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Sprawdzenie czy użytkownik jest właścicielem dokumentu
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Sprawdzenie czy dokument jest tworzony z poprawnymi danymi
    function hasValidEventData() {
      let data = request.resource.data;
      return data.userId == request.auth.uid
        && data.title is string && data.title.size() > 0
        && data.description is string
        && data.date is timestamp
        && data.location is string && data.location.size() > 0
        && data.maxGuests is number && data.maxGuests > 0
        && data.status in ['draft', 'active', 'completed', 'cancelled']
        && data.createdAt is timestamp
        && data.updatedAt is timestamp
        && data.guestCount is number
        && data.acceptedCount is number
        && data.pendingCount is number
        && data.declinedCount is number;
    }
    
    // Sprawdzenie czy aktualizacja dokumentu jest poprawna
    function hasValidEventUpdate() {
      let data = request.resource.data;
      return data.userId == resource.data.userId
        && (data.title is string && data.title.size() > 0)
        && (data.description is string)
        && (data.date is timestamp)
        && (data.location is string && data.location.size() > 0)
        && (data.maxGuests is number && data.maxGuests > 0)
        && (data.status in ['draft', 'active', 'completed', 'cancelled'])
        && data.updatedAt is timestamp;
    }
    
    // Wydarzenia
    match /events/{eventId} {
      allow read: if isAuthenticated() && (isOwner(resource.data.userId) || true); // Tymczasowo pozwól wszystkim zalogowanym
      allow create: if isAuthenticated() && hasValidEventData();
      allow update: if isAuthenticated() && isOwner(resource.data.userId) && hasValidEventUpdate();
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // Goście
    match /guests/{guestId} {
      // Odczyt - publiczny (potrzebny dla strony RSVP)
      allow get: if true;
      // Zapytania - tylko dla zalogowanych
      allow list: if isAuthenticated();
      
      allow create: if isAuthenticated() && (
        isOwner(request.resource.data.userId) ||
        exists(/databases/$(database)/documents/events/$(request.resource.data.eventId))
      );
      
      // Aktualizacja - pozwól publicznie (przez stronę RSVP) lub dla zalogowanych użytkowników
      // Walidacja tokenu RSVP odbywa się w kodzie aplikacji przed aktualizacją
      allow update: if 
        // Publiczna aktualizacja przez stronę RSVP
        (!isAuthenticated()) ||
        // Aktualizacja przez zalogowanego użytkownika
        (
          isAuthenticated() && (
            isOwner(resource.data.userId) ||
            resource.data.email == request.auth.token.email ||
            // Właściciel wydarzenia może aktualizować gości
            (
              exists(/databases/$(database)/documents/events/$(resource.data.eventId)) &&
              get(/databases/$(database)/documents/events/$(resource.data.eventId)).data.userId == request.auth.uid
            )
          )
        );
      
      allow delete: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        exists(/databases/$(database)/documents/events/$(resource.data.eventId)) &&
        get(/databases/$(database)/documents/events/$(resource.data.eventId)).data.userId == request.auth.uid
      );
    }
    
    // Aktywności
    match /activities/{activityId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      // Pozwól na tworzenie aktywności publicznie (przez system RSVP) lub przez zalogowanych
      allow create: if 
        !isAuthenticated() || 
        (isAuthenticated() && request.resource.data.userId == request.auth.uid);
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // Użytkownicy
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Notyfikacje
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // Analityki
    match /analytics/{analyticsId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // Kontakty
    match /contacts/{contactId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // Tokeny RSVP
    match /rsvpTokens/{tokenId} {
      // Odczyt pojedynczego tokenu - publiczny (potrzebny dla strony RSVP)
      allow get: if true;
      
      // Odczyt listy tokenów (queries) - tylko dla zalogowanych użytkowników
      // (potrzebny do sprawdzania czy token już istnieje)
      allow list: if isAuthenticated();
      
      // Tworzenie tokenu - tylko dla zalogowanych użytkowników
      allow create: if isAuthenticated() && (
        request.resource.data.eventGuestId is string &&
        request.resource.data.eventId is string &&
        request.resource.data.token is string &&
        request.resource.data.isUsed == false &&
        request.resource.data.createdAt is timestamp &&
        (request.resource.data.expiresAt is timestamp || request.resource.data.expiresAt == null)
      );
      
      // Aktualizacja tokenu - do oznaczania jako użyty (przez system RSVP)
      allow update: if true;
      
      // Usuwanie tokenów - tylko dla zalogowanych użytkowników
      allow delete: if isAuthenticated();
    }
  }
}
